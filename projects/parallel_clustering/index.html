<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Parallel clustering library | Tomáš Čelko </title> <meta name="author" content="Tomáš Čelko"> <meta name="description" content="Fast connected component analysis for hybrid pixel detectors"> <meta name="keywords" content="celko cluster clustering"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%9A%9B%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://tomascelko.github.io/projects/parallel_clustering/"> <script src="/assets/js/theme.js?9a0c749ec5240d9cda97bc72359a72c0"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Tomáš</span> Čelko </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications </a> </li> <li class="nav-item active"> <a class="nav-link" href="/projects/">projects <span class="sr-only">(current)</span> </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">cv </a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">teaching </a> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Parallel clustering library</h1> <p class="post-description">Fast connected component analysis for hybrid pixel detectors</p> </header> <article> <div class="row"> <div class="col-sm mt-3 mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/clusterer_cuda/icon/logoParallelClusterer-480.webp 480w,/assets/clusterer_cuda/icon/logoParallelClusterer-800.webp 800w,/assets/clusterer_cuda/icon/logoParallelClusterer-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/assets/clusterer_cuda/icon/logoParallelClusterer.png" class="img-fluid w-50 rounded z-depth-1" width="100%" height="auto" title="Parallel clustering logo" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <h2 id="about">About</h2> <p>This project implements a parallel clustering libraries for CPU and GPU intended for hybrid pixel detectors. By clustering, we mean connected-component analysis with respect to spatial and temporal pixel coordinates. Namely, it implements algorithms described <a href="https://iopscience.iop.org/article/10.1088/1748-0221/20/01/C01041" rel="external nofollow noopener" target="_blank"> here </a> published in Journal of Instrumentation.</p> <p>This project provides free access to source code for non-commercial puproposes on request. For access, do not hesitate to contact us. We kindly ask the users to cite the corresponding <a href="https://iopscience.iop.org/article/10.1088/1748-0221/20/01/C01041" rel="external nofollow noopener" target="_blank"> article </a>, should any of the described parallel clustering method be applied in your work.</p> <p>For potential applications, improvements, ideas, bugs or questions please contact me by email either at celko(at)ksvi.mff.cuni.cz or at tomas.celko(at)cvut.cz, I will be happy to help.</p> <h2 id="supported-hardware">Supported hardware</h2> <p>Currently we support clustering Timepix3 and Timepix4 hits in data-driven mode. Support for frame-based mode and multiple-detector configurations is planned. Support for other similar detectors or modes is a matter of demand, feel free to let us know about possible applications.</p> <h2 id="news">News</h2> <p>15.12.2025 - Parallel clustering 1.0 (Unstable) - Release of the new tile-based clustering algorithm. The release includes also GPU-side attribute computation including cluster energy, energy histograms and aggregation into frames as well as energy-based filtering.</p> <p>29.7.2025 - Latest windows build was deployed to the website and example cmake script was updated.</p> <p>29.7.2025 - Benchmarks confirm that tile-based algorithm outperforms the current one by better utilizing the GPU compute power. To store small tiles, low-latency memory was used which enabled further optimizations. Regarding the actual peformance on RTX 4070 Ti Super, it was around 30% for smallest clusters up to more than 100% increase for large ion clusters. Release is planned by the end of the year.</p> <p>4.4.2025 - New CUDA-based parallel clustering algorithm with possibly significantly lower memory usage was designed, implementation is expected during May/2025. This parallel algorithm could enable much higher degree of parallelization but it is best to wait for the implementation and the subsequent benchmarks.</p> <p>28.1.2025 - Test multiple combinations of parameters and fixed found bugs. Refactored the code to remove “CUDA separable compilation” (= device code linking) option which now increased the clustering throughput back to the values listed in the published paper (~10-15%).</p> <p>2.1.2025 - Added windows installer, but our gitlab linux distribution ci/cd pipelines seem to currently broken and therefore are not updated. The available version of .deb files should still be functional.</p> <p>28.12.2024 - Extended the installation documentation.</p> <p>26.12.2024 - Baseline testing of all prebuilt libraries has passed, continuing with parameter testing.</p> <p>19.12.2024 - We are currently working on finalizing the package for the first (alpha) release of the GPU package.</p> <h2 id="cpu-parallel-clustering">CPU parallel clustering</h2> <p>We implemented CPU-based parallel clustering directly as a part of the <a href="https://software.utef.cvut.cz/tracklab/" rel="external nofollow noopener" target="_blank"> Tracklab</a> software, where it can be used.</p> <p>Development of the standalone package is in progress.</p> <h2 id="gpu-parallel-clustering">GPU parallel clustering</h2> <h3 id="i-requirements">I. Requirements</h3> <p>Project targets Linux-based and Windows platforms. Since the implementation runs in CUDA, a CUDA-capable device is required to run the project.</p> <p>Prerequisites to link against the prebuilt library:</p> <ul> <li>Linux or Windows x86/64 platform (for others contact us for building from source)</li> <li>CUDA-capable device, compute capability &gt;= 6.7</li> <li>NVidia GPU Computing Toolkit &gt;= 12.4 (and a compatible nvidia driver, check with <code class="language-plaintext highlighter-rouge">nvidia-smi</code> command)</li> <li>CMake &gt;= 3.19</li> <li>C++ compiler compatible with C++17 standard</li> </ul> <h3 id="ii-installation">II. Installation</h3> <p>We provide user multiple options how to install our library:</p> <h4 id="option-1-from-installer-file-deb--exe---recommended">Option 1: From installer file (.deb / .exe) - recommended</h4> <ul> <li>download suitable installer file</li> <li>(optional) for .deb file, check the Lintian output, make sure there are no errors</li> <li>(important) make sure all prerequisites are matched - this is not checked by the package</li> <li>run the installer</li> </ul> <h4 id="option-2-from-prebuilt-zip-package">Option 2: From prebuilt .zip package</h4> <ul> <li>download suitable version for your platform from the table below</li> <li>extract the zip file to desired location. For linux, you may want to copy contents of the <code class="language-plaintext highlighter-rouge">include</code> folder to <code class="language-plaintext highlighter-rouge">usr/include/</code> and contents of <code class="language-plaintext highlighter-rouge">lib</code> folder to <code class="language-plaintext highlighter-rouge">/usr/lib/</code>. For Windows, you may want to copy contents of the extracted <code class="language-plaintext highlighter-rouge">clusterer_cuda</code> folder to <code class="language-plaintext highlighter-rouge">C:/Program Files</code> and let cmake know about path to <code class="language-plaintext highlighter-rouge">clusterer_cuda-config.cmake</code>. The next step might not be required if the files were placed in standard locations like <code class="language-plaintext highlighter-rouge">/usr/lib</code> </li> <li>letting cmake know about path to <code class="language-plaintext highlighter-rouge">clusterer_cuda-config.cmake</code> - either set <code class="language-plaintext highlighter-rouge">CMAKE_PREFIX_PATH</code> to directory where <code class="language-plaintext highlighter-rouge">clusterer_cuda-config.cmake</code> is located or add it to environmental <code class="language-plaintext highlighter-rouge">PATH</code> variable.</li> </ul> <h4 id="option-3-from-source">Option 3: From source</h4> <ul> <li>Request access to the repository by email - free for non-commercial applications assuming proper citation of the relevant article</li> <li>Create a build folder and generate build files with <code class="language-plaintext highlighter-rouge">cmake ..</code> or similar</li> <li>Build with <code class="language-plaintext highlighter-rouge">cmake --build . --config=Release</code> </li> </ul> <p>If you struggle with installation, feel free to reach out by email.</p> <h3 id="iii-linking">III. Linking</h3> <h4 id="option-1-use-find_package-from-your-cmakelists">Option 1: Use <code class="language-plaintext highlighter-rouge">find_package</code> from your cmakelists</h4> <p>We consider this to be the most convenient option. Based on the value of <code class="language-plaintext highlighter-rouge">CLUSTERER_CUDA_USE_STATIC</code> variable, the <code class="language-plaintext highlighter-rouge">clusterer_cuda-config.cmake</code> sets the variables <code class="language-plaintext highlighter-rouge">CLUSTERER_CUDA_INCLUDE_DIR</code> and <code class="language-plaintext highlighter-rouge">CLUSTERER_CUDA_LIBRARY</code>. An example part of cmake script can be found below:</p> <div class="language-cmake highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nb">cmake_minimum_required</span><span class="p">(</span>VERSION 3.18<span class="p">)</span>
<span class="nb">project</span><span class="p">(</span>clusterer_test LANGUAGES CUDA CXX<span class="p">)</span>

<span class="nb">enable_language</span><span class="p">(</span>CUDA<span class="p">)</span>
<span class="nb">find_package</span><span class="p">(</span>CUDAToolkit REQUIRED<span class="p">)</span>
<span class="nb">set</span><span class="p">(</span>CMAKE_CXX_STANDARD 17<span class="p">)</span>
<span class="nb">set</span><span class="p">(</span>CMAKE_CXX_STANDARD_REQUIRED True<span class="p">)</span>

<span class="c1">#we can set this variable, if we link dynamically and want to copy the .dll/.so file to the binary folder </span>
<span class="c1">#note, if it is not set, we need to make sure .dll/.so file is findable by the system</span>
<span class="nb">set</span><span class="p">(</span>CMAKE_BINARY_DIR_COPY_DLL <span class="s2">"</span><span class="si">${</span><span class="nv">CMAKE_CURRENT_LIST_DIR</span><span class="si">}</span><span class="s2">/build/Release"</span><span class="p">)</span>

<span class="nb">set</span><span class="p">(</span>CLUSTERER_CUDA_USE_STATIC ON<span class="p">)</span>  <span class="c1"># for static/dynamic linking, If building in debug mode, switching this to OFF can help</span>
<span class="nb">find_package</span><span class="p">(</span>clusterer_cuda REQUIRED<span class="p">)</span>
<span class="nb">message</span><span class="p">(</span>THESE_VARIABLES_SHOULD_BE_INITIALIZED: <span class="si">${</span><span class="nv">CLUSTERER_CUDA_FOUND</span><span class="si">}</span> <span class="si">${</span><span class="nv">CLUSTERER_CUDA_INCLUDE_DIR</span><span class="si">}</span> <span class="si">${</span><span class="nv">CLUSTERER_CUDA_LIBRARY</span><span class="si">}</span><span class="p">)</span>
<span class="nb">add_executable</span><span class="p">(</span>clusterer_test <span class="s2">"src/main.cpp"</span><span class="p">)</span>
<span class="nb">target_include_directories</span><span class="p">(</span>clusterer_test PRIVATE <span class="si">${</span><span class="nv">CLUSTERER_CUDA_INCLUDE_DIR</span><span class="si">}</span><span class="p">)</span>
<span class="nb">target_link_libraries</span><span class="p">(</span>clusterer_test PRIVATE 
    <span class="si">${</span><span class="nv">CLUSTERER_CUDA_LIBRARY</span><span class="si">}</span> 
    CUDA::cudart_static <span class="c1"># choose either cudart_static or cudart</span>
    CUDA::nvrtc      
<span class="p">)</span>
</code></pre></div></div> <h4 id="option-2-set-include-and-library-paths-manually">Option 2: Set include and library paths manually</h4> <p>Another option is to bypass cmake <code class="language-plaintext highlighter-rouge">find_package</code> completely and set <code class="language-plaintext highlighter-rouge">CLUSTERER_CUDA_INCLUDE_DIR</code> and <code class="language-plaintext highlighter-rouge">CLUSTERER_CUDA_LIBRARY</code> manually. This is also the case for non-cmake-based projects, like the ones in Visual Studio. In Visual Studio, go to <code class="language-plaintext highlighter-rouge">Configuration Properties &gt; C/C++ &gt; General</code> and set <code class="language-plaintext highlighter-rouge">Additional Include Directories</code>, and similarly for <code class="language-plaintext highlighter-rouge">Configuration Properties &gt; Linker &gt; General</code> set <code class="language-plaintext highlighter-rouge">Additional Library Directories</code>.</p> <h3 id="iv-example-use-up-to-date-with-version-10">IV. Example use (up-to-date with version 1.0):</h3> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"data_flow/external_dataflow_controller.h"</span><span class="cp">
#include</span> <span class="cpf">"data_structs/clustered_data.h"</span><span class="cp">
#include</span> <span class="cpf">"data_nodes/nodes_package.h"</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">clustering</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">test_clustering_tpx3</span><span class="p">()</span>
<span class="p">{</span>
  <span class="c1">// define function callback to receive clustered data</span>
  <span class="k">auto</span> <span class="n">output_callback</span> <span class="o">=</span> <span class="p">[](</span><span class="n">clustered_data</span><span class="o">&lt;</span><span class="n">tpx3_hit</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Returned with "</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;&lt;</span> <span class="s">" hits"</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"First hit: "</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="p">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="p">.</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="p">.</span><span class="n">toa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="p">.</span><span class="n">tot</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="p">.</span><span class="n">label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="c1">// Since version 1.0 we can also query the attributes</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"First cluster size:"</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="p">.</span><span class="n">attributes</span><span class="p">.</span><span class="n">cluster_sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"First cluster energy:"</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="p">.</span><span class="n">attributes</span><span class="p">.</span><span class="n">cluster_energy</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">const</span> <span class="kt">uint8_t</span> <span class="n">output_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// select output stream of frames</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"First pixel total energy in the frame:"</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="p">.</span><span class="n">attributes</span><span class="p">.</span><span class="n">cluster_energy_2d_map</span><span class="p">[</span><span class="n">output_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">"Index of the first pixel in the frame:"</span> <span class="o">&lt;&lt;</span> <span class="n">data</span><span class="p">.</span><span class="n">attributes</span><span class="p">.</span><span class="n">cluster_energy_2d_map_indices</span><span class="p">[</span><span class="n">output_index</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span> <span class="c1">// If pixel index has value j then j = frame_idx * sensor_matrix_size + pixel_matrix_coordinate (zero suppressed sparse encoding) -&gt; frame_idx and pixel matrix idx can be computed as follows: </span>
    <span class="c1">// frame_idx  = j div sensor_matrix_size</span>
    <span class="c1">// pixel_matrix_idx = j mod sensor_matrix_size</span>
    <span class="c1">// Note: the number of elements of data.attributes.cluster_energy_2d_map is data.attributes.nonzero_pixel_matrix_count_clustered</span>

    <span class="cm">/*process the data here in the callback, make a copy, as the data pointers might not be valid after callback returns...
      data.x, data.y, data.toa, data.tot
      //note: data.toa is uint64_t = 19 digits of precision - toa in nanoseconds or even smaller, controlled by parameter decimal digits 
    */</span>
  <span class="p">}</span>

  <span class="c1">//initialize controller with arguments</span>
  <span class="n">external_dataflow_controller</span><span class="o">&lt;</span><span class="n">tpx3_hit</span><span class="o">&gt;</span> <span class="n">controller_tpx3</span><span class="p">(</span><span class="n">node_args</span><span class="o">::</span><span class="n">load_tpx3_args</span><span class="p">(</span><span class="cm">/*pass algorithm parameters here in a config file*/</span> <span class="s">"config.txt"</span><span class="p">),</span> <span class="n">output_callback</span><span class="p">);</span>
  <span class="c1">//run the controller, after that we are ready to receive data  </span>
  <span class="n">controller_tpx3</span><span class="p">.</span><span class="n">run</span><span class="p">();</span>
 
  <span class="c1">//process hits in a loop, example</span>
  <span class="n">controller_tpx3</span><span class="p">.</span><span class="n">process_hit</span><span class="p">(</span><span class="mi">0</span> <span class="cm">/*pixel_idx*/</span><span class="p">,</span> <span class="mi">2</span> <span class="cm">/*coarse toa*/</span><span class="p">,</span> <span class="mi">3</span> <span class="cm">/*fine toa*/</span><span class="p">,</span> <span class="mi">4</span><span class="cm">/*tot*/</span><span class="p">);</span>
  <span class="c1">//Note: in versions &lt; 1.0 please call controller_tpx3.input()-&gt;process_hit() instead</span>

  <span class="c1">//after sufficient amount of hits is processed, the callback is called</span>
  <span class="p">...</span>
  <span class="c1">//stop the dataflow, and flush not-yet processed hits and call callback for the last time</span>
  <span class="n">controller_tpx3</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <p>And for using the clustering library with timepix4 data folow similar approach:</p> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"data_flow/external_dataflow_controller.h"</span><span class="cp">
#include</span> <span class="cpf">"data_structs/clustered_data.h"</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">clustering</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">test_clustering_tpx4</span><span class="p">()</span>
<span class="p">{</span>
<span class="c1">// define function callback to receive clustered data</span>
  <span class="k">auto</span> <span class="n">output_callback</span> <span class="o">=</span> <span class="p">[](</span><span class="n">clustered_data</span><span class="o">&lt;</span><span class="n">tpx4_hit</span><span class="o">&gt;</span> <span class="n">data</span><span class="p">){...}</span>
  
  <span class="c1">//initialize controller with arguments, for definition of "output_callback see the example above for timepix3"</span>
  <span class="n">external_dataflow_controller</span><span class="o">&lt;</span><span class="n">tpx4_hit</span><span class="o">&gt;</span> <span class="n">controller_tpx4</span><span class="p">(</span><span class="n">node_args</span><span class="o">::</span><span class="n">load_tpx4_args</span><span class="p">(</span><span class="cm">/*pass algorithm parameters here in a config file*/</span> <span class="s">"config.txt"</span><span class="p">),</span> <span class="n">output_callback</span><span class="p">);</span>
  <span class="c1">//run the controller, after that we are ready to receive data</span>
  <span class="n">controller_tpx4</span><span class="p">.</span><span class="n">run</span><span class="p">();</span>
  <span class="c1">//Note: in versions &lt; 1.0 please call controller_tpx4.input()-&gt;process_hit() instead</span>

  <span class="c1">//process hits in a loop, notice the addition of ultra fine toa</span>
  <span class="n">controller_tpx4</span><span class="o">-&gt;</span><span class="n">process_hit</span><span class="p">(</span><span class="mi">0</span> <span class="cm">/*pixel_idx*/</span><span class="p">,</span> <span class="mi">2</span> <span class="cm">/*coarse toa*/</span><span class="p">,</span> <span class="mi">3</span> <span class="cm">/*fine toa*/</span><span class="p">,</span> <span class="mi">4</span> <span class="cm">/*ultra fine toa*/</span><span class="p">,</span> <span class="mi">5</span><span class="cm">/*tot*/</span><span class="p">);</span>
  <span class="c1">//after sufficient amount of hits is processed, the callback is called</span>
  <span class="p">...</span>
  <span class="c1">//stop the dataflow, and flush not-yet processed hits and call callback for the last time</span>
  <span class="n">controller_tpx4</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> <p>And finally, an example, how the <code class="language-plaintext highlighter-rouge">config.txt</code> file might look like:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//(i) Configuration for clustering - mandatory

max_hitrate_mhz = 300 // maximum possible hitrate that can occur during max_unsortedness period of time
max_unsortedness_mus = 500 // maximum unorderedness of hits on the input
max_cluster_join_time_ns = 300 // maximum time difference of hits to be considered neighboring
buffer_size = 7000000 // host and device buffer size
host_buffer_count = 8 // number of pinned-memory buffers allocated on the host
cuda_streams_per_worker = 4 // number of cuda streams in each clustering worker
cuda_thread_count = 7680 // degree of parallelization, use carefully based on the buffer_size and available hardware
cuda_min_launch_stream_count = 4 // minimum number of buffers required to run the clustering
cuda_clustering_threads_per_block = 128 // number of threads in a single cuda thread block
print_info_dt_ms = 500 // frequency of printing information about the dataflow
toa_ns_decimal_digits = 1 // decimal digits of toa 0 = 1ns, 1 = 0.1ns, 2 = 0.01ns ...
cuda_init_threads_per_block = 256 // threads per block used for initialization of auxiliary datastructures
_label_cache_size = 32 // size of the label cache in shared memory
_hit_data_cache_size = 12 // size of the hit data cache, beware of the available shared memory on a GPU

// (ii) configuration for attributes - optional (applicable since 1.0)

discard_non_attribute_data = false // remove x,y,toa, tot and label data, only preserve attributes - reduces copying load
attribute_energy = true // convert tot clock ticks to keV
attribute_cluster_size = true // compute pixel count for each cluster explicitly (implicit from labels field)
attribute_cluster_energy = true // compute sum of energy of each pixel in each cluster
attribute_cluster_energy_2d_map = true // compute energy-weighted centroid of clusters and aggregate them into the 2D frame further defined by section (iii)

attribute_cluster_energy_spectrum = true // compute cluster energy histogram, if true, also set the lower and upper bound as well as bin count
attribute_cluster_energy_spectrum_min = 0 // lower bound of the histogram (first bin start)
attribute_cluster_energy_spectrum_max = 100 // upper bound of the histogram (last bin)
attribute_cluster_energy_spectrum_bin_count = 50 // number of histogram bins

// (iii) configuration for attributes -optional, applies to cluster_energy_2d_map only (applicable since 1.0)

attribute_cluster_energy_filter_1 = 0:5 // for each energy filter interval we get a output sequence of frames, one can define arbitrarily many of such intervals but each with a non-trivial performance overhead (0:5 means include clusters in range from 0 keV to 5keV)
attribute_cluster_energy_filter_2 = 5:10 // similar as filter_1, don't forget to number the filters in a sequence 1,2,3... without gaps
attribute_cluster_energy_filter_3 = 10:20 // similar as  filter_1
//...
attribute_frame_length_s = 1 //frame length in seconds, can be floating point number, If attribute_cluster_energy_2d_map = true the frame length must be specified



// (iv) extra metadata required for attribute computation - required if energy-based attribute is to be computed (applicable since 1.0)

calibration_folder = D:/path/to/calibration/ceofficients/H07-W0052[CdTe]/calib_pars // path to calibration folder containing a.txt, b.txt c.txt, t.txt calibration files

</code></pre></div></div> <h3 id="v-prebuilt-library-available-for-download">V. Prebuilt library available for download:</h3> <table> <tr> <th>Platform</th> <th>GPU Library, prebuilt (Stable, 0.1)</th> <th>GPU Library, prebuilt (Latest, 1.0)</th> </tr> <tr> <td>Windows installer</td> <td><a href="/assets/clusterer_cuda/build_win/clusterer_cuda_installer.exe" download="clusterer_cuda_installer.exe">Download clusterer_cuda_installer.exe</a></td> <td><a href="/assets/clusterer_cuda_dev_gpu/build_win/clusterer_cuda_installer.exe" download="clusterer_cuda_installer.exe">Download clusterer_cuda_installer.exe</a></td> </tr> <tr> <td>Windows (archive)</td> <td><a href="/assets/clusterer_cuda/build_win/clusterer_cuda_win.zip" download="clusterer_cuda_win.zip">Download clusterer_cuda_win.zip</a></td> <td><a href="/assets/clusterer_cuda_dev_gpu/build_win/clusterer_cuda_win.zip" download="clusterer_cuda_win.zip">Download clusterer_cuda_win.zip</a></td> </tr> <tr> <td>Other Unix-based system (archive)</td> <td><a href="/assets/clusterer_cuda/build_ubuntu2404/clusterer_cuda.zip" download="clusterer_cuda.zip">Download clusterer_cuda.zip</a></td> <td><a href="/assets/clusterer_cuda_dev_gpu/build_ubuntu2404/clusterer_cuda.zip" download="clusterer_cuda.zip">Download clusterer_cuda.zip</a></td> </tr> <tr> <td>Ubuntu 22.04</td> <td><a href="/assets/clusterer_cuda/build_ubuntu2204/clusterer_cuda_x64.deb" download="clusterer_cuda_ubuntu2204.deb">Download clusterer_cuda_ubuntu2204.deb</a></td> <td><a href="/assets/clusterer_cuda_dev_gpu/build_ubuntu2204/clusterer_cuda_x64.deb" download="clusterer_cuda_ubuntu2204.deb">Download clusterer_cuda_ubuntu2204.deb</a></td> </tr> <tr> <td>Ubuntu 24.04</td> <td><a href="/assets/clusterer_cuda/build_ubuntu2404/clusterer_cuda_x64.deb" download="clusterer_cuda_ubuntu2404.deb">Download clusterer_cuda_ubuntu2404.deb</a></td> <td><a href="/assets/clusterer_cuda_dev_gpu/build_ubuntu2404/clusterer_cuda_x64.deb" download="clusterer_cuda_ubuntu2404.deb">Download clusterer_cuda_ubuntu2404.deb</a></td> </tr> <tr> <td>Debian 12</td> <td><a href="/assets/clusterer_cuda/build_debian12/clusterer_cuda_x64.deb" download="clusterer_cuda_debian12.deb">Download clusterer_cuda_debian12.deb</a></td> <td><a href="/assets/clusterer_cuda_dev_gpu/build_debian12/clusterer_cuda_x64.deb" download="clusterer_cuda_debian12.deb">Download clusterer_cuda_debian12.deb</a></td> </tr> </table> </article> <h2>References</h2> <div class="publications"> </div> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Tomáš Čelko. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. Last updated: December 17, 2025. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>addBackToTop();</script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script>let searchTheme=determineComputedTheme();const ninjaKeys=document.querySelector("ninja-keys");"dark"===searchTheme?ninjaKeys.classList.add("dark"):ninjaKeys.classList.remove("dark");const openSearchModal=()=>{const e=$("#navbarNav");e.hasClass("show")&&e.collapse("hide"),ninjaKeys.open()};</script> <script>const ninja=document.querySelector("ninja-keys");ninja.data=[{id:"nav-about",title:"about",section:"Navigation",handler:()=>{window.location.href="/"}},{id:"nav-publications",title:"publications",description:"publications by categories in reversed chronological order. generated by jekyll-scholar.",section:"Navigation",handler:()=>{window.location.href="/publications/"}},{id:"nav-projects",title:"projects",description:"A few projects which I implemented - varying from smaller to larger ones.",section:"Navigation",handler:()=>{window.location.href="/projects/"}},{id:"nav-cv",title:"cv",description:"This is a description of the page. You can modify it in &#39;_pages/cv.md&#39;. You can also change or remove the top pdf download button.",section:"Navigation",handler:()=>{window.location.href="/cv/"}},{id:"nav-teaching",title:"teaching",description:"A short history of the courses I taught.",section:"Navigation",handler:()=>{window.location.href="/teaching/"}},{id:"post-google-gemini-updates-flash-1-5-gemma-2-and-project-astra",title:'Google Gemini updates: Flash 1.5, Gemma 2 and Project Astra <svg width="1.2rem" height="1.2rem" top=".5rem" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg>',description:"We\u2019re sharing updates across our Gemini family of models and a glimpse of Project Astra, our vision for the future of AI assistants.",section:"Posts",handler:()=>{window.open("https://blog.google/technology/ai/google-gemini-update-flash-ai-assistant-io-2024/","_blank")}},{id:"post-displaying-external-posts-on-your-al-folio-blog",title:'Displaying External Posts on Your al-folio Blog <svg width="1.2rem" height="1.2rem" top=".5rem" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg"><path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg>',description:"",section:"Posts",handler:()=>{window.open("https://medium.com/@al-folio/displaying-external-posts-on-your-al-folio-blog-b60a1d241a0a?source=rss-17feae71c3c4------2","_blank")}},{id:"projects-audio-visualizer",title:"audio_visualizer",description:"A tool to play .wav tracks and visualize fast fourier transform decomposition of the played tune.",section:"Projects",handler:()=>{window.location.href="/projects/audio_visualizer/"}},{id:"projects-chess",title:"Chess",description:"Chess with a simple GUI, and AI oponent based on minimax with alpha-beta prunning algorithm",section:"Projects",handler:()=>{window.location.href="/projects/chess_game/"}},{id:"projects-clusterer-lite",title:"clusterer_lite",description:"Liteweight implementation of clustering targeted at on-chip data processing.",section:"Projects",handler:()=>{window.location.href="/projects/clusterer_lite/"}},{id:"projects-pretraining-of-deep-cnn-autoencoders",title:"Pretraining of deep CNN autoencoders",description:"Autoencoders pretrained on unlabeled data from Timepix3 to improve accuracy.",section:"Projects",handler:()=>{window.location.href="/projects/cnn_autoencoders_pretraining/"}},{id:"projects-comparison-of-dimensionality-reduction-techniques",title:"Comparison of dimensionality reduction techniques",description:"Application of pretrained NN combined with dimensionality reduction for visualization and classification of image data.",section:"Projects",handler:()=>{window.location.href="/projects/dimensionality_reduction/"}},{id:"projects-neat-coevolution",title:"Neat-coevolution",description:"Evolving neural networks using NEAT in co-evolution environment",section:"Projects",handler:()=>{window.location.href="/projects/neat_coevolution/"}},{id:"projects-parallel-clustering-library",title:"Parallel clustering library",description:"Fast connected component analysis for hybrid pixel detectors",section:"Projects",handler:()=>{window.location.href="/projects/parallel_clustering/"}},{id:"projects-pixel-auto",title:"pixel_auto",description:"Development of methodology for application of finite automatons to particle classification",section:"Projects",handler:()=>{window.location.href="/projects/pixel_auto/"}},{id:"socials-email",title:"Send email",section:"Socials",handler:()=>{window.open("mailto:%79%6F%75@%65%78%61%6D%70%6C%65.%63%6F%6D","_blank")}},{id:"socials-orcid",title:"ORCID",section:"Socials",handler:()=>{window.open("https://orcid.org/0009-0003-3077-3223","_blank")}},{id:"socials-google-scholar",title:"Google Scholar",section:"Socials",handler:()=>{window.open("https://scholar.google.com/citations?user=qc6CJjYAAAAJ","_blank")}},{id:"socials-rss",title:"RSS Feed",section:"Socials",handler:()=>{window.open("/feed.xml","_blank")}},{id:"light-theme",title:"Change theme to light",description:"Change the theme of the site to Light",section:"Theme",handler:()=>{setThemeSetting("light")}},{id:"dark-theme",title:"Change theme to dark",description:"Change the theme of the site to Dark",section:"Theme",handler:()=>{setThemeSetting("dark")}},{id:"system-theme",title:"Use system default theme",description:"Change the theme of the site to System Default",section:"Theme",handler:()=>{setThemeSetting("system")}}];</script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>